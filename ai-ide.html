<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis IDE - AI Assistant Edition</title>
    <style>
        /* Copy ALL styles from collab-ide.html first */
        /* Then ADD these AI-specific styles: */
        
        /* AI Assistant Panel */
        .ai-assistant-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100vh;
            background-color: #1e1e1e;
            border-left: 1px solid #3e3e42;
            display: none;
            flex-direction: column;
            z-index: 999;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .ai-assistant-panel.active {
            display: flex;
        }
        
        .ai-header {
            padding: 15px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-close-btn {
            cursor: pointer;
            font-size: 20px;
            color: #888;
            background: none;
            border: none;
            padding: 0;
        }
        
        .ai-close-btn:hover {
            color: #fff;
        }
        
        .ai-tabs {
            display: flex;
            background-color: #252526;
            border-bottom: 1px solid #3e3e42;
        }
        
        .ai-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .ai-tab:hover {
            background-color: #2a2a2a;
        }
        
        .ai-tab.active {
            border-bottom-color: #007acc;
            color: #007acc;
        }
        
        .ai-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .ai-chat {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .ai-message {
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            max-width: 90%;
        }
        
        .ai-message.user {
            background-color: #094771;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message.assistant {
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
        }
        
        .ai-message pre {
            background-color: #1e1e1e;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 5px 0;
        }
        
        .ai-message code {
            background-color: #1e1e1e;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .ai-input-container {
            padding: 15px;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
        }
        
        .ai-input {
            flex: 1;
            padding: 8px;
            background-color: #3c3c3c;
            color: #cccccc;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 13px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }
        
        .ai-send-btn {
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            align-self: flex-end;
        }
        
        .ai-send-btn:hover {
            background-color: #1a86d3;
        }
        
        .ai-send-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        /* AI Suggestions */
        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .ai-suggestion {
            padding: 6px 12px;
            background-color: #3c3c3c;
            border: 1px solid #3e3e42;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-suggestion:hover {
            background-color: #484848;
            border-color: #007acc;
        }
        
        /* Code Analysis Results */
        .code-analysis {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .analysis-item {
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .analysis-severity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .severity-error {
            background-color: #5a1d1d;
            color: #f48771;
        }
        
        .severity-warning {
            background-color: #5a4a1d;
            color: #cca700;
        }
        
        .severity-info {
            background-color: #1d4a5a;
            color: #75beff;
        }
        
        /* AI Toggle Button */
        .ai-toggle-btn {
            position: fixed;
            right: 20px;
            bottom: 60px;
            width: 50px;
            height: 50px;
            background-color: #007acc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 998;
            transition: all 0.3s;
        }
        
        .ai-toggle-btn:hover {
            background-color: #1a86d3;
            transform: scale(1.1);
        }
        
        .ai-toggle-btn.active {
            background-color: #f48771;
        }
        
        /* Loading animation */
        .ai-loading {
            display: flex;
            gap: 4px;
            padding: 10px;
            justify-content: center;
        }
        
        .ai-loading span {
            width: 8px;
            height: 8px;
            background-color: #007acc;
            border-radius: 50%;
            animation: ai-pulse 1.4s ease-in-out infinite;
        }
        
        .ai-loading span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .ai-loading span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes ai-pulse {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Adjust main content when AI panel is open */
        .main-content.ai-panel-open {
            margin-right: 400px;
        }
    </style>
</head>
<body>
    <!-- Copy entire body content from collab-ide.html -->
    <!-- Then ADD: -->
    
    <!-- AI Toggle Button -->
    <div class="ai-toggle-btn" onclick="toggleAIPanel()" title="AI Assistant (Ctrl+Shift+A)">
        ðŸ¤–
    </div>
    
    <!-- AI Assistant Panel -->
    <div class="ai-assistant-panel" id="aiAssistantPanel">
        <div class="ai-header">
            <h3><span>ðŸ¤–</span> AI Assistant</h3>
            <button class="ai-close-btn" onclick="toggleAIPanel()">Ã—</button>
        </div>
        
        <div class="ai-tabs">
            <div class="ai-tab active" onclick="switchAITab('chat')">Chat</div>
            <div class="ai-tab" onclick="switchAITab('analyze')">Analyze</div>
            <div class="ai-tab" onclick="switchAITab('refactor')">Refactor</div>
        </div>
        
        <div class="ai-content">
            <!-- Chat Tab -->
            <div id="aiChatTab" class="ai-tab-content">
                <div class="ai-suggestions">
                    <div class="ai-suggestion" onclick="askAI('Explain this code')">Explain code</div>
                    <div class="ai-suggestion" onclick="askAI('Find bugs')">Find bugs</div>
                    <div class="ai-suggestion" onclick="askAI('Optimize performance')">Optimize</div>
                    <div class="ai-suggestion" onclick="askAI('Add comments')">Add comments</div>
                </div>
                
                <div class="ai-chat" id="aiChat">
                    <div class="ai-message assistant">
                        ðŸ‘‹ Hi! I'm your AI coding assistant. I can help you:
                        <ul>
                            <li>Explain code</li>
                            <li>Find and fix bugs</li>
                            <li>Suggest optimizations</li>
                            <li>Write documentation</li>
                            <li>Refactor code</li>
                        </ul>
                        Select some code and ask me anything!
                    </div>
                </div>
            </div>
            
            <!-- Analyze Tab -->
            <div id="aiAnalyzeTab" class="ai-tab-content" style="display: none;">
                <button onclick="analyzeCurrentFile()">Analyze Current File</button>
                <div id="analysisResults"></div>
            </div>
            
            <!-- Refactor Tab -->
            <div id="aiRefactorTab" class="ai-tab-content" style="display: none;">
                <div class="ai-suggestions">
                    <div class="ai-suggestion" onclick="refactorCode('extract-function')">Extract Function</div>
                    <div class="ai-suggestion" onclick="refactorCode('simplify')">Simplify</div>
                    <div class="ai-suggestion" onclick="refactorCode('modern-syntax')">Modernize</div>
                    <div class="ai-suggestion" onclick="refactorCode('add-types')">Add Types</div>
                </div>
                <div id="refactorResults"></div>
            </div>
        </div>
        
        <div class="ai-input-container">
            <textarea 
                class="ai-input" 
                id="aiInput" 
                placeholder="Ask me anything about your code..."
                onkeydown="handleAIInputKeydown(event)"
            ></textarea>
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">Send</button>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // Copy ALL scripts from collab-ide.html
        // Then ADD these AI-specific functions:
        
        let aiApiKey = localStorage.getItem('openai_api_key') || '';
        let aiConversation = [];
        let isAIProcessing = false;
        
        // Initialize AI features
        function initializeAI() {
            // Check for API key
            if (!aiApiKey) {
                showAPIKeyPrompt();
            }
            
            // Add keyboard shortcut
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    e.preventDefault();
                    toggleAIPanel();
                }
            });
        }
        
        function showAPIKeyPrompt() {
            const key = prompt('Please enter your OpenAI API key:');
            if (key) {
                aiApiKey = key;
                localStorage.setItem('openai_api_key', key);
            }
        }
        
        function toggleAIPanel() {
            const panel = document.getElementById('aiAssistantPanel');
            const toggleBtn = document.querySelector('.ai-toggle-btn');
            const mainContent = document.querySelector('.main-content');
            
            panel.classList.toggle('active');
            toggleBtn.classList.toggle('active');
            mainContent.classList.toggle('ai-panel-open');
            
            // Resize Monaco editor
            if (editor) {
                setTimeout(() => editor.layout(), 300);
            }
        }
        
        function switchAITab(tab) {
            // Hide all tabs
            document.querySelectorAll('.ai-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.ai-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`ai${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message || isAIProcessing) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get context
            const context = getCodeContext();
            
            // Show loading
            showAILoading();
            isAIProcessing = true;
            document.getElementById('aiSendBtn').disabled = true;
            
            try {
                const response = await callOpenAI(message, context);
                addChatMessage(response, 'assistant');
            } catch (error) {
                console.error('AI Error:', error);
                addChatMessage('Sorry, I encountered an error. Please check your API key or try again.', 'assistant');
            } finally {
                hideAILoading();
                isAIProcessing = false;
                document.getElementById('aiSendBtn').disabled = false;
            }
        }
        
        function getCodeContext() {
            let context = {
                currentFile: currentFile,
                selection: null,
                fullCode: null
            };
            
            if (editor) {
                const selection = editor.getSelection();
                if (!selection.isEmpty()) {
                    context.selection = editor.getModel().getValueInRange(selection);
                }
                context.fullCode = editor.getValue();
            }
            
            return context;
        }
        
        async function callOpenAI(message, context) {
            const messages = [
                {
                    role: 'system',
                    content: `You are an expert coding assistant integrated into a code editor. 
                    You help with code explanation, debugging, optimization, and refactoring. 
                    Be concise but thorough. Use code blocks with language indicators.
                    Current file: ${context.currentFile || 'No file open'}`
                }
            ];
            
            // Add conversation history
            aiConversation.forEach(msg => messages.push(msg));
            
            // Add current message with context
            let userMessage = message;
            if (context.selection) {
                userMessage = `${message}\n\nSelected code:\n\`\`\`${getFileLanguage()}\n${context.selection}\n\`\`\``;
            } else if (context.fullCode && message.toLowerCase().includes('this')) {
                userMessage = `${message}\n\nCurrent file content:\n\`\`\`${getFileLanguage()}\n${context.fullCode}\n\`\`\``;
            }
            
            messages.push({ role: 'user', content: userMessage });
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiApiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4-turbo-preview',
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1500
                })
            });
            
            if (!response.ok) {
                throw new Error('API request failed');
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            // Update conversation history
            aiConversation.push({ role: 'user', content: userMessage });
            aiConversation.push({ role: 'assistant', content: aiResponse });
            
            // Keep only last 10 messages
            if (aiConversation.length > 20) {
                aiConversation = aiConversation.slice(-20);
            }
            
            return aiResponse;
        }
        
        function addChatMessage(message, sender) {
            const chat = document.getElementById('aiChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            // Convert markdown code blocks to HTML
            const formattedMessage = formatAIMessage(message);
            messageDiv.innerHTML = formattedMessage;
            
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
            
            // Add copy buttons to code blocks
            messageDiv.querySelectorAll('pre').forEach(pre => {
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copy';
                copyBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; padding: 2px 8px; background: #007acc; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(pre.textContent);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                };
                pre.style.position = 'relative';
                pre.appendChild(copyBtn);
            });
        }
        
        function formatAIMessage(message) {
            // Convert markdown to HTML
            return message
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre><code class="language-${lang || 'plaintext'}">${escapeHtml(code.trim())}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showAILoading() {
            const chat = document.getElementById('aiChat');
            const loading = document.createElement('div');
            loading.className = 'ai-loading';
            loading.id = 'aiLoading';
            loading.innerHTML = '<span></span><span></span><span></span>';
            chat.appendChild(loading);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function hideAILoading() {
            const loading = document.getElementById('aiLoading');
            if (loading) loading.remove();
        }
        
        function askAI(prompt) {
            document.getElementById('aiInput').value = prompt;
            sendAIMessage();
        }
        
        function handleAIInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIMessage();
            }
        }
        
        function getFileLanguage() {
            if (!currentFile) return 'plaintext';
            const ext = currentFile.split('.').pop();
            return getLanguageMode(ext);
        }
        
        async function analyzeCurrentFile() {
            if (!currentFile || !editor) {
                alert('Please open a file first');
                return;
            }
            
            const code = editor.getValue();
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = '<div class="ai-loading"><span></span><span></span><span></span></div>';
            
            try {
                const analysis = await callOpenAI(
                    'Analyze this code for potential bugs, performance issues, and best practice violations. Format as a list with severity levels.',
                    { fullCode: code, currentFile }
                );
                
                resultsDiv.innerHTML = `<div class="code-analysis">${formatAnalysisResults(analysis)}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="analysis-item">Error analyzing code</div>';
            }
        }
        
        function formatAnalysisResults(analysis) {
            // Parse AI response and format nicely
            return analysis
                .split('\n')
                .filter(line => line.trim())
                .map(line => {
                    let severity = 'info';
                    if (line.toLowerCase().includes('error') || line.toLowerCase().includes('bug')) {
                        severity = 'error';
                    } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('issue')) {
                        severity = 'warning';
                    }
                    
                    return `
                        <div class="analysis-item">
                            <span class="analysis-severity severity-${severity}">${severity}</span>
                            <span>${line}</span>
                        </div>
                    `;
                })
                .join('');
        }
        
        async function refactorCode(type) {
            const selection = editor?.getSelection();
            if (!selection || selection.isEmpty()) {
                alert('Please select code to refactor');
                return;
            }
            
            const code = editor.getModel().getValueInRange(selection);
            const resultsDiv = document.getElementById('refactorResults');
            resultsDiv.innerHTML = '<div class="ai-loading"><span></span><span></span><span></span></div>';
            
            const prompts = {
                'extract-function': 'Extract this code into a well-named function with parameters',
                'simplify': 'Simplify this code while maintaining functionality',
                'modern-syntax': 'Modernize this code using latest JavaScript/TypeScript features',
                'add-types': 'Add TypeScript types to this code'
            };
            
            try {
                const refactored = await callOpenAI(prompts[type], { selection: code });
                resultsDiv.innerHTML = formatAIMessage(refactored);
                
                // Add apply button
                const applyBtn = document.createElement('button');
                applyBtn.textContent = 'Apply Refactoring';
                applyBtn.style.cssText = 'margin-top: 10px; padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;';
                applyBtn.onclick = () => {
                    // Extract code from the response
                    const codeMatch = refactored.match(/```[\w]*\n([\s\S]*?)```/);
                    if (codeMatch) {
                        editor.executeEdits('ai-refactor', [{
                            range: selection,
                            text: codeMatch[1].trim()
                        }]);
                    }
                };
                resultsDiv.appendChild(applyBtn);
            } catch (error) {
                resultsDiv.innerHTML = '<div>Error refactoring code</div>';
            }
        }
        
        // Initialize AI when app loads
        const originalInitializeApp = initializeApp;
        initializeApp = async function() {
            await originalInitializeApp();
            initializeAI();
        };
    </script>
</body>
</html>